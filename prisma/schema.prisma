generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////////
// USER (IDENTITY)
////////////////////////

model User {
  id          String     @id @default(cuid())
  email       String     @unique
  username    String?    @unique
  firstName   String?
  lastName    String?
  displayName String?
  status      UserStatus @default(ACTIVE)
  lastLoginAt DateTime?
  deletedAt   DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  authAccounts         AuthAccount[]
  sessions             Session[]
  roleAssignments      UserRoleAssignment[]
  refreshTokens        RefreshToken[]
  securityEvents       SecurityEvent[]
  mfaChallenges        MfaChallenge[]
  permissionOverrides  UserPermissionOverride[]
  customerProfile      CustomerProfile?
  workerProfile        WorkerProfile?
  businessOwnerProfile BusinessOwnerProfile?

  mfaFactors         MfaFactor[]
  auditLogs          UserAuditLog[]
  passwordResets     PasswordReset[]
  emailVerifications EmailVerification[]

  @@index([email])
  @@index([status])
  @@index([deletedAt])
  @@map("users")
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

////////////////////////
// AUTHENTICATION
////////////////////////

model AuthAccount {
  id           String       @id @default(cuid())
  userId       String
  provider     AuthProvider
  providerId   String
  passwordHash String?
  isPrimary    Boolean      @default(false)
  verifiedAt   DateTime?
  lastUsedAt   DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([userId, provider])
  @@index([userId])
  @@map("auth_accounts")
}

enum AuthProvider {
  LOCAL
  GOOGLE
  FACEBOOK
  APPLE
}

////////////////////////
// SESSIONS
////////////////////////

model Session {
  id            String         @id @default(cuid())
  userId        String
  sessionToken  String         @unique
  ipAddress     String?
  userAgent     String?
  deviceInfo    String?
  expiresAt     DateTime
  revokedAt     DateTime?
  refreshTokens RefreshToken[]
  mfaChallenges MfaChallenge[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([expiresAt])
  @@index([sessionToken])
  @@map("sessions")
}

////////////////////////
// PASSWORD MANAGEMENT
////////////////////////

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_resets")
}

model EmailVerification {
  id         String    @id @default(cuid())
  userId     String
  email      String
  token      String    @unique
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verifications")
}

////////////////////////
// PROFILES
////////////////////////

model CustomerProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  phone           String?
  phoneVerifiedAt DateTime?
  birthDate       DateTime?
  address         Json?
  preferences     Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@map("customer_profiles")
}

model BusinessOwnerProfile {
  id           String    @id @default(cuid())
  userId       String    @unique
  businessName String
  taxId        String?   @unique
  address      Json?
  verifiedAt   DateTime?
  verifiedBy   String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  companies Company[]

  @@index([taxId])
  @@map("business_owner_profiles")
}

model WorkerProfile {
  id           String    @id @default(cuid())
  userId       String    @unique
  companyId    String
  position     String?
  department   String?
  employeeId   String?
  hiredAt      DateTime  @default(now())
  terminatedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict)

  @@index([companyId, terminatedAt])
  @@index([employeeId])
  @@map("worker_profiles")
}

////////////////////////
// COMPANY
////////////////////////

model Company {
  id                  String                   @id @default(cuid())
  ownerId             String
  name                String
  slug                String                   @unique
  description         String?
  logo                String?
  website             String?
  industry            String?
  status              CompanyStatus            @default(PENDING)
  verifiedAt          DateTime?
  suspendedAt         DateTime?
  closedAt            DateTime?
  deletedAt           DateTime?
  metadata            Json?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  permissionOverrides UserPermissionOverride[]

  owner           BusinessOwnerProfile @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  workers         WorkerProfile[]
  roleAssignments UserRoleAssignment[]

  @@index([ownerId])
  @@index([status, deletedAt])
  @@index([slug])
  @@map("companies")
}

enum CompanyStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CLOSED
}

////////////////////////
// ROLES & PERMISSIONS (RBAC)
////////////////////////

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(true)
  isActive    Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions RolePermission[]
  users       UserRoleAssignment[]

  @@index([isSystem, isActive])
  @@map("roles")
}

model Permission {
  id            String                   @id @default(cuid())
  resource      String
  action        String
  description   String?
  userOverrides UserPermissionOverride[]
  createdAt     DateTime                 @default(now())

  roles RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id         String    @id @default(cuid())
  userId     String
  roleId     String
  companyId  String?
  assignedBy String?
  assignedAt DateTime  @default(now())
  expiresAt  DateTime?
  revokedAt  DateTime?

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, companyId])
  @@index([userId, revokedAt])
  @@index([roleId])
  @@index([companyId])
  @@index([expiresAt])
  @@map("user_role_assignments")
}

////////////////////////
// GUEST CHECKOUT
////////////////////////

model GuestCheckout {
  id              String    @id @default(cuid())
  email           String
  sessionToken    String    @unique
  checkoutData    Json
  expiresAt       DateTime
  convertedUserId String?   @unique
  convertedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([email])
  @@index([expiresAt])
  @@index([convertedUserId])
  @@map("guest_checkouts")
}

////////////////////////
// MFA (Multi-Factor Authentication)
////////////////////////

model MfaFactor {
  id     String  @id @default(cuid())
  userId String
  type   MfaType

  secretCipher String
  secretIv     String
  secretTag    String

  verifiedAt DateTime?
  lastUsedAt DateTime?
  revokedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
}

enum MfaType {
  TOTP
  SMS
  EMAIL
  WEBAUTHN
}

////////////////////////
// AUDIT LOGS
////////////////////////

model UserAuditLog {
  id           String   @id @default(cuid())
  userId       String
  action       String
  resource     String?
  resourceId   String?
  success      Boolean
  errorMessage String?
  ipAddress    String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("user_audit_logs")
}

////////////////////////
// NOTIFICATIONS
////////////////////////

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  readAt    DateTime?
  deletedAt DateTime?
  createdAt DateTime         @default(now())

  @@index([userId, readAt])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  SYSTEM
  SECURITY
  ACCOUNT
  COMPANY
  ALERT
}

////////////////////////
// RATE LIMITING
////////////////////////

model RateLimit {
  id          String   @id @default(cuid())
  identifier  String
  action      String
  count       Int      @default(1)
  windowStart DateTime
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([identifier, action, windowStart])
  @@index([expiresAt])
  @@map("rate_limits")
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  sessionId String
  token     String    @unique
  familyId  String
  ipAddress String?
  userAgent String?
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([expiresAt])
  @@index([familyId])
  @@map("refresh_tokens")
}

model TokenBlacklist {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@map("token_blacklist")
}

model SecurityEvent {
  id          String   @id @default(cuid())
  userId      String?
  email       String?
  eventType   String
  severity    String
  description String
  ipAddress   String?
  userAgent   String?
  blocked     Boolean  @default(false)
  actionTaken String?
  metadata    Json?
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([eventType])
  @@index([createdAt])
  @@map("security_events")
}

model MfaChallenge {
  id         String             @id @default(cuid())
  userId     String
  sessionId  String
  factorType MfaType
  reason     MfaChallengeReason
  satisfied  Boolean            @default(false)
  expiresAt  DateTime
  createdAt  DateTime           @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, factorType])
  @@index([userId])
  @@index([expiresAt])
  @@map("mfa_challenges")
}

enum MfaChallengeReason {
  LOGIN
  SENSITIVE_ACTION
}

model UserPermissionOverride {
  id           String    @id @default(cuid())
  userId       String
  permissionId String
  companyId    String?
  isGranted    Boolean
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  company    Company?   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId, companyId])
  @@index([expiresAt])
  @@map("user_permission_overrides")
}

////////////////////////
// NewsletterSubscription
////////////////////////

model NewsletterSubscription {
  id     String  @id @default(uuid())
  email  String  @unique
  active Boolean @default(true)

  unsubscribedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("newsletter_subscriptions")
}

////////////////////////
// ContactMessage
////////////////////////

model ContactMessage {
  id        String   @id @default(cuid())

  name      String
  email     String
  phone     String?
  subject   String?
  message   String

  status    MessageStatus @default(NEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  readAt    DateTime?

  @@index([email])
  @@index([status])
}

enum MessageStatus {
  NEW
  READ
  REPLIED
  ARCHIVED
  SPAM
}
